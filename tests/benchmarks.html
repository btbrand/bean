<!DOCTYPE HTML>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Bean Benchmarks</title>
    <script src="../support/syn/synthetic.js"></script>
    <script src="../support/syn/mouse.js"></script>
    <script src="../support/syn/browsers.js"></script>
    <script src="../support/syn/key.js"></script>
    <script src="../support/qwery/qwery.js"></script>
    <script src="../bean.js"></script>
    <script type="text/javascript">
      var bp = bean.noConflict();
    </script>
    <script src="../src/bean.js"></script>
    <script type="text/javascript">
      var bd = bean.noConflict();
    </script>
    <script src="../support/nwevents/src/nwevents.js"></script>
    <script src="../support/nwevents/src/modules/nwevents-pubsub.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
    <style>
     #fixtures {
       position:absolute;
       top: -999em;
     }
      body {
        width: 700px;
        margin: 0 auto;
        font: 300 16px 'helvetica neue', helvetica, arial;
        text-shadow: 0 2px 2px #CCC;
      }
      ul,li {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      li {
        font-size: 16px;
      }
      h1, h2 {
        margin: 0;
        font-weight: normal;
        font-size: 30px;
      }
      h2 {
        font-size: 20px;
      }
      .result {
        background-color: lightGreen;
        margin-top: 15px;
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 0 5px #ccc;
      }
      .result .inner {
        padding: 7px;
        border-radius: 5px;
        background-color: #BDFCC9;
      }
      .result .note {
        font-size: 9pt;
        font-style: italic;
      }
      .result .name {
        display: block;
        float: left;
        width: 150px;
      }
      .result .iters {
        margin-left: 5px;
      }
      .win {
        color: rgb(0, 125, 0);
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Bean Benchmarks</h1>
     <p style="font-style: italic; font-size: 9pt;">CAUTION: these libraries all handle events differently so comparing speed is a fraught exercise. The benchmarks here are intended to help improve Bean's speed with the other libaries included as a rough guide, knowing that the other libraries have various shortcuts that can make it easier. For example, NW doesn't have a flexibility comparable to Bean which allows it to optimise certain paths. Likewise, jQuery is happy to append its own unique IDs to both DOM elements and any object you want to do a pub/sub on; which Bean aims to avoid.</i></p>
     <div id="results"></div>
     <ol id="tests"></ol>
     <div id="fixtures">
       <input id="input" type="text" />
       <input id="input2" type="text" />
       <div id="foo">
         <div id="bar" class="bar">
            <div id="bang" class="bang"></div>
         </div>
         <div id="baz" class="baz"></div>
       </div>
     </div>


<script type="text/javascript">
function result(idx, name, results) {
  var r = document.createElement('div'), html
  r.setAttribute('id', 'result_' + idx)
  r.className = 'result'
  html = '<div class="inner"><h2>Benchmark: <i>' + name + '</i></h2>'
  html += '<div class="note">Iterations per second, more is better</div>'
  html += '<ul>'
  for (var i = 0; i < results.length; i++) {
    html += '<li><span class="name">' + results[i].name + ':</span> <span class="iters" id="result_' + idx + '_' + i + '">' + results[i].iters + '</span></li>'
  }
  html += '</ul></div>'
  r.innerHTML = html
  qwery('#results')[0].appendChild(r)
}
// generate a random, unique function
function rndfunc() {
  var fn
  eval("fn = (function(){return " + Math.random() + "})")
  return fn
}

function basicBench(maxms, handlers, fires, el, type, add, remove, fire) {
  var iters = 0, j, fna = [], start = +new Date
  while (++iters) {
    for (j = 0; j < handlers; j++)
      add(el, type, fna[j] || (fna[j] = rndfunc()))
    for (j = 0; j < fires; j++)
      fire(el, type)
    for (j = 0; j < handlers; j++)
      remove(el, type, fna[j])
    if (+new Date - start >= maxms) break
  }
  return Math.round(1000 / ((+new Date - start) / iters))
}

function manyElementsBench(maxms, handlers, elements, type, add, remove, fire) {
  var iters = 0, j, fna = [], ela = [], start = +new Date
  while (++iters) {
    for (j = 0; j < handlers; j++)
      add(ela[j % elements] || (ela[j % elements] = document.createElement('p')), type, fna[j] || (fna[j] = rndfunc()))
    for (j = 0; j < ela.length; j++)
      fire(ela[j], type)
    for (j = 0; j < handlers; j++)
      remove(ela[j % elements], type, fna[j])
    if (+new Date - start >= maxms) break
  }
  return Math.round(1000 / ((+new Date - start) / iters))
}

var maxms = 500, listeners = 25, elements = 10, fires = 10
var bench = [
  function(ind) {
    result(ind, 'Element click add/click/remove', [
      { name: 'Original', iters: basicBench(maxms, listeners, 1, qwery('#input')[0], 'click', bp.add, bp.remove, function(el) { Syn.click(el) }) },
      { name: 'New', iters: basicBench(maxms, listeners, 1, qwery('#input')[0], 'click', bd.add, bd.remove, function(el) { Syn.click(el) }) },
      { name: 'NWEvent', iters: basicBench(maxms, listeners, 1, qwery('#input')[0], 'click', NW.Event.listen, NW.Event.unlisten, function(el) { Syn.click(el) }) },
      { name: 'jQuery', iters: basicBench(maxms, listeners, 1, qwery('#input')[0], 'click'
        , function(el, type, fn) { jQuery(el).on(type, fn) }
        , function(el, type, fn) { jQuery(el).off(type, fn) }
        , function(el) { Syn.click(el) })
      }
    ])
  }
, function(ind) {
    result(ind, 'Element custom add/fire/remove', [
      { name: 'Original', iters: basicBench(maxms, listeners, fires, qwery('#input')[0], 'whatup', bp.add, bp.remove, function(el, type) { bp.fire(el, type) }) },
      { name: 'New',     iters: basicBench(maxms, listeners, fires, qwery('#input')[0], 'whatup', bd.add, bd.remove, function(el, type) { bd.fire(el, type) }) },
      { name: 'NWEvent', iters: basicBench(maxms, listeners, fires, qwery('#input')[0], 'whatup', NW.Event.listen, NW.Event.unlisten, function(el, type) { NW.Event.dispatch(el, type) }) },
      { name: 'jQuery', iters: basicBench(maxms, listeners, fires, qwery('#input')[0], 'whatup'
        , function(el, type, fn) { jQuery(el).on(type, fn) }
        , function(el, type, fn) { jQuery(el).off(type, fn) }
        , function(el, type) { jQuery(el).trigger(type) })
      }
    ])
  }
, function(ind) {
    result(ind, 'Object custom add/fire/remove', [
      { name: 'Original', iters: basicBench(maxms, listeners, fires, {}, 'whatup', bp.add, bp.remove, function(el, type) { bp.fire(el, type) }) },
      { name: 'New', iters: basicBench(maxms, listeners, fires, {}, 'whatup', bd.add, bd.remove, function(el, type) { bd.fire(el, type) }) },
      { name: 'NWEvent', iters: basicBench(maxms, listeners, fires, {}, 'whatup', NW.Event.subscribe, NW.Event.unsubscribe, function(el, type) { NW.Event.publish(el, type) }) },
      { name: 'jQuery', iters: basicBench(maxms, listeners, {}, 'whatup'
        , function(el, type, fn) { jQuery(el).on(type, fn) }
        , function(el, type, fn) { jQuery(el).off(type, fn) }
        , function(el, type) { jQuery(el).trigger(type) })
      }
    ])
  }
, function(ind) {
    result(ind, 'Many-element click add/click/remove', [
      { name: 'Original', iters: manyElementsBench(maxms, listeners, elements, 'click', bp.add, bp.remove, function(el) { Syn.click(el) }) },
      { name: 'New', iters: manyElementsBench(maxms, listeners, elements, 'click', bd.add, bd.remove, function(el) { Syn.click(el) }) },
      { name: 'NWEvent', iters: manyElementsBench(maxms, listeners, elements, 'click', NW.Event.listen, NW.Event.unlisten, function(el) { Syn.click(el) }) },
      { name: 'jQuery', iters: manyElementsBench(maxms, listeners, elements, 'click'
        , function(el, type, fn) { jQuery(el).on(type, fn) }
        , function(el, type, fn) { jQuery(el).off(type, fn) }
        , function(el) { Syn.click(el) })
      }
    ])
  }
]

var benchIndex = 0
!function run() {
  setTimeout(function() {
    bench[benchIndex](benchIndex)
    if (bench[++benchIndex]) run()
  }, 0)
}()

</script>
  </body>
</html>
